<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Downloading Trained Sagemaker Models • sagemaker</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Downloading Trained Sagemaker Models">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sagemaker</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/sagemaker.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/load-model.html">Downloading Trained Sagemaker Models</a>
    </li>
    <li>
      <a href="../articles/sagemaker-vs-sagemaker.html">Sagemaker API vs. Sagemaker R Package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Downloading Trained Sagemaker Models</h1>
            
      
      
      <div class="hidden name"><code>load-model.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Sagemaker is great for training, but sometimes you don’t want the overhead (cost and time) of <code>predict.sagemaker</code> or <code>batch_predict</code>.</p>
<p>Luckily, AWS Sagemaker saves every model in S3, and you can download and use it locally with the right configuration.</p>
<p>For xgboost models (more to come in the future), I’ve written <code>sagemaker_load_model</code>, which loads the trained Sagemaker model into your current R session.</p>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>Let’s use the <code><a href="../reference/abalone.html">sagemaker::abalone</a></code> dataset once again, but this time let’s try classification instead of regression.</p>
<p>First we’ll identify the classes with the highest frequency, so we can eliminate the low-variance ones.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sagemaker)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt; Attaching package: 'dplyr'</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; The following objects are masked from 'package:stats':</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#&gt;     filter, lag</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#&gt; The following objects are masked from 'package:base':</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co">#&gt;     intersect, setdiff, setequal, union</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rsample)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co">#&gt; Loading required package: tidyr</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(recipes)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co">#&gt; Attaching package: 'recipes'</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co">#&gt; The following object is masked from 'package:stats':</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co">#&gt;     step</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">top_rings &lt;-<span class="st"> </span>sagemaker<span class="op">::</span>abalone <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(rings) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">n =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/n.html">n</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="co">#&gt; Selecting by n</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1-28" data-line-number="28">top_rings</a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co">#&gt; # A tibble: 10 x 2</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="co">#&gt;    rings     n</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="co">#&gt;    &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="co">#&gt;  1     9   689</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="co">#&gt;  2    10   634</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="co">#&gt;  3     8   568</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="co">#&gt;  4    11   487</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="co">#&gt;  5     7   391</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="co">#&gt;  6    12   267</span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="co">#&gt;  7     6   259</span></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"><span class="co">#&gt;  8    13   203</span></a>
<a class="sourceLine" id="cb1-40" data-line-number="40"><span class="co">#&gt;  9    14   126</span></a>
<a class="sourceLine" id="cb1-41" data-line-number="41"><span class="co">#&gt; 10     5   115</span></a></code></pre></div>
<p>We’ll use <code>recipes</code> to transform the dataset into the proper format for xgboost. We must ensure that:</p>
<ol style="list-style-type: decimal">
<li>classes are integers</li>
<li>classes are labeled 0 to number of classes - 1.</li>
<li>outcome is the first column</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">rec &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/recipes/man/recipe.html">recipe</a></span>(rings <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> sagemaker<span class="op">::</span>abalone) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/recipes/man/step_filter.html">step_filter</a></span>(rings <span class="op">%in%</span><span class="st"> </span>top_rings<span class="op">$</span>rings) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/recipes/man/step_integer.html">step_integer</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/recipes/man/has_role.html">all_outcomes</a></span>(), <span class="dt">zero_based =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/recipes/man/prep.html">prep</a></span>(<span class="dt">training =</span> sagemaker<span class="op">::</span>abalone, <span class="dt">retain =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">abalone_class &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/recipes/man/juice.html">juice</a></span>(rec) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(rings, <span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">everything</a></span>())</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">abalone_class <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(rings) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">n =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/n.html">n</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(n)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co">#&gt; # A tibble: 10 x 2</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co">#&gt;    rings     n</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">#&gt;    &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">#&gt;  1     0   115</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">#&gt;  2     9   126</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">#&gt;  3     8   203</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#&gt;  4     1   259</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#&gt;  5     7   267</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co">#&gt;  6     2   391</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co">#&gt;  7     6   487</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co">#&gt;  8     3   568</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co">#&gt;  9     5   634</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="co">#&gt; 10     4   689</span></a></code></pre></div>
<p>Then we’ll split into test/validation and upload to S3 for training.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">split &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rsample/man/initial_split.html">initial_split</a></span>(abalone_class)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">train_path &lt;-<span class="st"> </span><span class="kw"><a href="../reference/s3.html">s3</a></span>(<span class="kw"><a href="../reference/s3_bucket.html">s3_bucket</a></span>(), <span class="st">"abalone-class-train.csv"</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">validation_path &lt;-<span class="st"> </span><span class="kw"><a href="../reference/s3.html">s3</a></span>(<span class="kw"><a href="../reference/s3_bucket.html">s3_bucket</a></span>(), <span class="st">"abalone-class-test.csv"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/read_s3.html">write_s3</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/rsample/man/as.data.frame.rsplit.html">analysis</a></span>(split), train_path)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="../reference/read_s3.html">write_s3</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/rsample/man/as.data.frame.rsplit.html">assessment</a></span>(split), validation_path)</a></code></pre></div>
</div>
<div id="training" class="section level2">
<h2 class="hasAnchor">
<a href="#training" class="anchor"></a>Training</h2>
<p>Frist, we need to set the xgboost hyperparameters for multiclassification. See <a href="https://xgboost.readthedocs.io/en/latest/parameter.html#learning-task-parameters">here</a> for the official list of xgboost parameters.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">xgb_estimator &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sagemaker_estimator.html">sagemaker_xgb_estimator</a></span>()</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; You are not in a sagemaker hosted notebook.</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; Pulling local role in ~/.aws/config</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">xgb_estimator<span class="op">$</span><span class="kw">set_hyperparameters</span>(</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  <span class="dt">eval_metric =</span> <span class="st">"mlogloss"</span>,</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="dt">objective =</span> <span class="st">"multi:softmax"</span>,</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="dt">num_class =</span> 10L</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">)</a></code></pre></div>
<p><code>objective = "multi:softmax"</code> will return the predicted class, while <code>objective = "multi:softprob"</code> returns a tibble with probabilities for each class<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<p>Next, we’ll set some ranges to tune over and start training.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">ranges &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="dt">max_depth =</span> <span class="kw"><a href="../reference/sagemaker_ranges.html">sagemaker_integer</a></span>(<span class="dv">3</span>, <span class="dv">20</span>),</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="dt">colsample_bytree =</span> <span class="kw"><a href="../reference/sagemaker_ranges.html">sagemaker_continuous</a></span>(<span class="dv">0</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="dt">subsample =</span> <span class="kw"><a href="../reference/sagemaker_ranges.html">sagemaker_continuous</a></span>(<span class="dv">0</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">)</a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">tune &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sagemaker_hyperparameter_tuner.html">sagemaker_hyperparameter_tuner</a></span>(</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  xgb_estimator, <span class="kw"><a href="../reference/s3_split.html">s3_split</a></span>(train_path, validation_path), ranges, <span class="dt">max_jobs =</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">)</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">tune</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; Name: sagemaker-xgboost-191201-1356-002-1c263073 </span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt; Tuning Strategy: Random </span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt; Evaluation Metric: mlogloss , 1.43704 </span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt;  </span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt; Best hyperparameters:</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt;   colsample_bytree subsample max_depth</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt; 1            0.516     0.512         6</span></a></code></pre></div>
</div>
<div id="loading-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-the-model" class="anchor"></a>Loading the model</h2>
<p>Now we can download the Sagemaker model artifact from S3 and load it into the R session.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">xgb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sagemaker_load_model.html">sagemaker_load_model</a></span>(tune)</a></code></pre></div>
<p>For xgboost Sagemaker models, <code>sagemaker_load_model</code> loads a <a href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.Booster">Booster</a> object from the xgboost Python package:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(xgb)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#&gt; [1] "xgboost.core.Booster"  "python.builtin.object"</span></a></code></pre></div>
<p>To use this feature, you must have the xgboost Python package installed. You can download and install it with</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># not run</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">sagemaker<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/sagemaker/man/sagemaker_install.html">sagemaker_install_xgboost</a></span>()</a></code></pre></div>
<p>The Sagemaker R package loads the Booster object into the R session with <a href="https://rstudio.github.io/reticulate/">reticulate</a>. Therefore, all methods and attributes are available in R.</p>
<pre><code>#&gt;  [1] "_validate_features"        "attr"                     
#&gt;  [3] "attributes"                "best_iteration"           
#&gt;  [5] "best_ntree_limit"          "best_score"               
#&gt;  [7] "boost"                     "booster"                  
#&gt;  [9] "copy"                      "dump_model"               
#&gt; [11] "eval"                      "eval_set"                 
#&gt; [13] "feature_names"             "feature_types"            
#&gt; [15] "get_dump"                  "get_fscore"               
#&gt; [17] "get_score"                 "get_split_value_histogram"
#&gt; [19] "handle"                    "load_model"               
#&gt; [21] "load_rabit_checkpoint"     "predict"                  
#&gt; [23] "save_model"                "save_rabit_checkpoint"    
#&gt; [25] "save_raw"                  "set_attr"                 
#&gt; [27] "set_param"                 "trees_to_dataframe"       
#&gt; [29] "update"</code></pre>
</div>
<div id="predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#predictions" class="anchor"></a>Predictions</h2>
<p>However, you need to know the xgboost Python package to work with the local model.</p>
<p>The sagemaker R package also includes <code>predict.xgboost.core.Booster</code> to help you easily make predictions on this object:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">pred &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(xgb, abalone_class[, <span class="dv">-1</span>])</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">glimpse</a></span>(pred)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt; Observations: 3,739</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; Variables: 1</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; $ .pred &lt;dbl&gt; 2, 4, 4, 2, 2, 4, 8, 3, 4, 4, 5, 7, 2, 2, 2, 2, 2, 5, 4, 4…</span></a></code></pre></div>
<p>This method returns predictions in tibbles, and it attempts to conform to the <a href="https://tidymodels.github.io/parsnip/reference/predict.model_fit.html">tidymodel</a> standard.</p>
<p>Unfortunately, <a href="https://github.com/awslabs/amazon-sagemaker-examples/issues/479">at the moment</a> type (<code>"class"</code> or <code>"prob"</code>) cannot be supported.</p>
<p>If you want both probability and class predictions, I recommend you default to <code>objective = "multi:softprob"</code> or <code>objective = "binary:logistic"</code> for probabilities and convert to outcomes after the predictions are returned.</p>
</div>
<div id="analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis" class="anchor"></a>Analysis</h2>
<p>Next, we can map the data and predictions back to the true values:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">ring_map &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rsample/man/reexports.html">tidy</a></span>(rec, <span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw">unnest</span>(value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="dt">rings_integer =</span> integer, <span class="dt">rings_actual =</span> value)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">rings_actual &lt;-<span class="st"> </span>abalone_class <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(ring_map, <span class="dt">by =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"rings"</span> =<span class="st"> "rings_integer"</span>)) </a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">rings_pred &lt;-<span class="st"> </span>pred <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(ring_map, <span class="dt">by =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">".pred"</span> =<span class="st"> "rings_integer"</span>))</a></code></pre></div>
<p>And calculate the confusion matrix:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="dt">pred =</span> rings_pred<span class="op">$</span>rings_actual, <span class="dt">actual =</span> rings_actual<span class="op">$</span>rings_actual)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="co">#&gt;     actual</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#&gt; pred   5   6   7   8   9  10  11  12  13  14</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co">#&gt;   5   79  16  11   3   1   0   0   0   0   0</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co">#&gt;   6   21 147  34  21   8   1   1   2   1   0</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt;   7   13  71 255  70  36  22  14   3   6   2</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt;   8    2  15  61 315  90  44  19  11   9   6</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">#&gt;   9    0   8  25 111 431 123  80  49  27  17</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co">#&gt;   10   0   0   4  35  69 375  73  62  31  30</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="co">#&gt;   11   0   1   1  10  43  53 283  35  35  16</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="co">#&gt;   12   0   0   0   1   3   8  10  92   3   4</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="co">#&gt;   13   0   1   0   2   7   7   7  10  90  13</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="co">#&gt;   14   0   0   0   0   1   1   0   3   1  38</span></a></code></pre></div>
<p>We can also see the model fit:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">logs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sagemaker_training_job_logs.html">sagemaker_training_job_logs</a></span>(tune<span class="op">$</span>model_name)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">logs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="st">`</span><span class="dt">train:mlogloss</span><span class="st">`</span><span class="op">:</span><span class="st">`</span><span class="dt">validation:mlogloss</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(iteration, value, <span class="dt">color =</span> name)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>()</a></code></pre></div>
<p><img src="load-model_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
</div>
<div id="multiclass-probability" class="section level1">
<h1 class="hasAnchor">
<a href="#multiclass-probability" class="anchor"></a>Multiclass probability</h1>
<p>For fun, let’s also see train a model using <code>objective = "multi:softprob"</code> for comparsion.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">xgb_estimator2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sagemaker_estimator.html">sagemaker_xgb_estimator</a></span>()</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">#&gt; You are not in a sagemaker hosted notebook.</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="co">#&gt; Pulling local role in ~/.aws/config</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">xgb_estimator2<span class="op">$</span><span class="kw">set_hyperparameters</span>(</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">  <span class="dt">eval_metric =</span> <span class="st">"mlogloss"</span>,</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">  <span class="dt">objective =</span> <span class="st">"multi:softprob"</span>,</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">  <span class="dt">num_class =</span> 10L</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">)</a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">tune2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sagemaker_hyperparameter_tuner.html">sagemaker_hyperparameter_tuner</a></span>(</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  xgb_estimator2, <span class="kw"><a href="../reference/s3_split.html">s3_split</a></span>(train_path, validation_path), ranges, <span class="dt">max_jobs =</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">)</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">tune2</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="co">#&gt; Name: sagemaker-xgboost-191201-2049-005-a115b6b5 </span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="co">#&gt; Tuning Strategy: Random </span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="co">#&gt; Evaluation Metric: mlogloss , 1.40881 </span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="co">#&gt;  </span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="co">#&gt; Best hyperparameters:</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co">#&gt;   colsample_bytree subsample max_depth</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="co">#&gt; 1            0.906     0.672        16</span></a></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">xgb2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sagemaker_load_model.html">sagemaker_load_model</a></span>(tune2)</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">pred2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(xgb2, abalone_class[, <span class="dv">-1</span>])</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">glimpse</a></span>(pred2)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="co">#&gt; Observations: 3,739</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">#&gt; Variables: 10</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="co">#&gt; $ .pred_0 &lt;dbl&gt; 0.021558676, 0.011293630, 0.010710401, 0.019016407, 0.01…</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co">#&gt; $ .pred_1 &lt;dbl&gt; 0.17314099, 0.01839421, 0.02251971, 0.15380934, 0.020601…</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="co">#&gt; $ .pred_2 &lt;dbl&gt; 0.61966711, 0.01386215, 0.05297577, 0.72650898, 0.686832…</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="co">#&gt; $ .pred_3 &lt;dbl&gt; 0.03697968, 0.04486087, 0.09038249, 0.03128297, 0.122178…</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="co">#&gt; $ .pred_4 &lt;dbl&gt; 0.03868733, 0.62501806, 0.70947081, 0.01891461, 0.058164…</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="co">#&gt; $ .pred_5 &lt;dbl&gt; 0.03771019, 0.11568346, 0.03889939, 0.01147735, 0.018013…</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="co">#&gt; $ .pred_6 &lt;dbl&gt; 0.02170349, 0.05026899, 0.02544681, 0.01027075, 0.027434…</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="co">#&gt; $ .pred_7 &lt;dbl&gt; 0.015020613, 0.072794594, 0.019079974, 0.009080383, 0.01…</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="co">#&gt; $ .pred_8 &lt;dbl&gt; 0.019516161, 0.030553145, 0.015705083, 0.010099456, 0.02…</span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14"><span class="co">#&gt; $ .pred_9 &lt;dbl&gt; 0.016015753, 0.017270876, 0.014809566, 0.009539749, 0.01…</span></a></code></pre></div>
<p>In this case, the outcome is a tibble with an associated probability for each class.</p>
<p>Then we can derive the predicted class by finding the class with the highest probability for each row (variable) of the tibble.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">pred2_class &lt;-<span class="st"> </span>pred2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">variable =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">    .pred_<span class="dv">0</span><span class="op">:</span>.pred_<span class="dv">9</span>, <span class="dt">names_to =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"name"</span>, <span class="st">".pred"</span>), </a>
<a class="sourceLine" id="cb23-5" data-line-number="5">    <span class="dt">names_sep =</span> <span class="st">"_"</span>, <span class="dt">names_ptypes =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">name =</span> <span class="kw"><a href="https://rdrr.io/r/base/character.html">character</a></span>(), <span class="dt">.pred =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>())</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(variable) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(value <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(.pred)</a>
<a class="sourceLine" id="cb23-11" data-line-number="11"></a>
<a class="sourceLine" id="cb23-12" data-line-number="12"><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">glimpse</a></span>(pred2_class)</a>
<a class="sourceLine" id="cb23-13" data-line-number="13"><span class="co">#&gt; Observations: 3,739</span></a>
<a class="sourceLine" id="cb23-14" data-line-number="14"><span class="co">#&gt; Variables: 1</span></a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="co">#&gt; $ .pred &lt;dbl&gt; 2, 4, 4, 2, 2, 4, 9, 5, 4, 4, 5, 7, 2, 4, 5, 2, 6, 5, 7, 4…</span></a></code></pre></div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p> You can also use <code>eval_metric = "merror"</code>, although <code>"mlogloss"</code> is usually better in practice.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#introduction">Introduction</a><ul class="nav nav-pills nav-stacked">
<li><a href="#data">Data</a></li>
      <li><a href="#training">Training</a></li>
      <li><a href="#loading-the-model">Loading the model</a></li>
      <li><a href="#predictions">Predictions</a></li>
      <li><a href="#analysis">Analysis</a></li>
      </ul>
</li>
      <li><a href="#multiclass-probability">Multiclass probability</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Timothy Mastny.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
